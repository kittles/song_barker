# overview
this codebase consists of several components:

- a web server that
provides a back end for the mobile app,
serves user generated cards over the internet, and
provides javascript for the mobile app to use for puppet animation.
- a web server that is deployed as a cluster that handles
cpu intensive audio processing tasks. this server only receives
requests from the first server.
- static assets that the app requires for song generation and user
stock images and crops
- lots of scripts to do lots of little tasks, mostly related to
keeping things in sync between the bucket and the database.

## key terms

### the back end
this is the first web server mentioned

### the cluster
this is the second thing mentioned

### the bucket
this is a google cloud services bucket where static assets are made accessible
to the app

### stock assets
these are things that the user's account is pre populated with
when they first create their account. its just dog images and dog barks.

### raw
this is what i call the raw audio that a user records, before it has
been chopped into usable pieces

### crop
this is what i call a piece of the raw audio file, after it has been
processed. its generally a discrete sound, or in the case of medium
and long crops, a sound with a decent start and ending. i think tovi
and jeremy call them "barks"

### sequence
this is what i call the thing that results when you map a set of crops
to a melody and generate the audio file.

### greeting card / card
this is the thing you actually share with other people, generated by the app

### puppet
this is what i call the three.js scene with (typically) a dog that can
be animated. you can control it kind of like a puppet, hence the name.


## basic architecture

### back end
there are two deployements hosted on digital ocean, a dev and production.
in both cases, the basic deployment looks like an ubuntu 18.04 os
running a nginx server which proxies to an express server, whose process
is managed by pm2. persistence is handled with a sqlite database.

### cluster
the cluster is a docker container. inside, there is a bare bones express server.
the container is uploaded to google cloud services and cluster-ized with kubernetes.


# back end endpoints

## REST api
the first category of endpoints are basically CRUD operations. they are automatically
generated based on the contents of `/server/models.js`, which is roughly a schema of
the database as well as some rules about object permissions. for each object, some subset of
the following are made available:
- GET `/get/<object_type>/<pk>`: return json representing the object
- GET `/all/<object_type>`: return an array of all objects belonging to the requester
- POST `/<object_type>`: send a json object here to create it in the db
- PATCH `/<object_type>/<pk>`: update the object with whatever attributes you include in a json object
- DELETE `/<object_type>/<pk>`: delete the object (this may not actually delete it, just set it to hidden)

## accounts
the second category of endpoints are for user account creation

- POST `/openid-token/<platform>`: send openid token here to log in. i think this is
only used for google tokens, because there is a seperate `/facebook-token` endpoint, but i can't
remember. platform should be one of `"android"` or `"ios"`. i think tovi is sending the token
as the whole request's body.

- POST `/facebook-token`: send a facebook token here to log in. this endpoint will look for the
token as an attribute of the request's body named `"facebook_token"`

these are some openid endpoints that i think google wants you to have. i am not sure
how stringent they are but it would probably be good to get some actual copy here

- GET `/openid-home`

- GET `/openid-privacy`

- GET `/openid-tos`

for manual account generation, these are the relevant apis:

- POST `/manual-login`: log in a user via email and password combo
expects body params: `email`, `password`

- POST `/create-account`: create a user account and log them in
expects body params: `email`, `password`

- GET `/email-available/:email`: check if an email is available. you can use this to provide feedback to user, before actually
trying to create the account (which will also check for availability)

- POST `/change-password`: change currently logged in user's password
expects body params: `old_password` this needs to match for the request to success,
`new_password` whatever man

- POST `/temp-password`: sets the users password to a autogenerated password and emails it to them
expects body params: `user_id` (this is most likely an email)

- GET `/confirm/<uuid>`: confirms an account

- GET `/agree-to-terms`: agrees to terms for requesters account

- GET`/is-logged-in`: returns a json object with info about session state

- GET `/logout`: disassociates session from user account, which is the same thing as logging them out

- POST `/delete-account`: deletes the account assocated with the request.

## card sharing
these are for sharing links to cards the users have generated

- POST `/to_card_key`: generate a card key for sharing card. expects body params `card_uuid`, `recipient`,
and `has_envelope`

- GET `/c/<card_key>`: returns a web page with the card (this is what people will see when they follow
the link someone has shared)

## custom client app endpoints
these are for the other tasks the client app needs to do

- POST `/signed-upload-url`: get a signed url so client can upload file to bucket.
expects body params `filepath` and `content_type`

- POST `/cloud/to_crops`: generate crops from a raw audio file.
expects body params `uuid` and `image_id`. the image is used for naming crops, and is optional

- POST `/cloud/to_sequence`: generate a sequence from some crops.
expects body params `uuids` (an array) and `song_id`

- GET `/`: the landing page for the website.

- GET `/describe`: shows the contents of `/server/models.js`.
this was just an adhoc way of documenting the object models, its only on dev






## contents
this readme is just a brief overview of the project, at the end i will
list the other files that have information on specific topics. the structure here is
- basic overview
- slightly more detailed description of major components
- brief info on deployments
- list of more specific guides


## basics
K-9 Karaoke (formerly song / sound barker) is made of up of some fairly discrete pieces:

- mobile app
- public facing web server, aka the back end (this includes web front end code)
- scalable kubernetes cluster for high cpu tasks

the project has steadilly grown in scope over the year, and you will probably
notice that in some of the more ad-hoc design choices, and naming conventions.
the mobile app has been developed by Tovi, and the web server and cluster have
been developed by Patrick (the person writing these docs). i'll try to give a
succinct description here of the basic functionality provided by the different
components, before going into more detail about the pieces of each of them.

## the back end
the back end is an express server that has
- CRUD-like apis
- custom endpoints for things like audio processing and card generation
- provider of static assets, like the javascript used to generate and animate the puppet,
as well as a page that users can view shared cards

it uses a sqlite database and the dev and prod deployments have nginx sitting in front
of the express server, and nginx handles the static assets.

just a bit more about the components here, and i will go into more detail on each
in their own sections.

### CRUD apis
i just rolled my own "orm", because the intially functionality needed was very
small. its grown a bit, and the orm and associated endpoints are a little crufty at
this point. i specify a "schema" in `server/models.js`, and the server will create
the endpoints and such from this.

### audio processing
the audio processing, which was initially developed to be run on the same machine
as the server, has become too cpu intensive to handle all but a handful of users
concurrently. you'll see a somewhat strange dir structure, with an
`/audio_processing` dir with audio processing scripts in it (which are not used now), and a
`/audio_processing/cloud` dir with another set of similar looking scripts (they are not the same, and
they ARE used)

### static assets / puppet
the bulk of the web front end (the web page where users go to see shared cards)
is in `server/public/puppet`, with all the logic in `puppet.js` within that dir.
this puppet code has undergone several pretty significant overhauls and has a lot
of dead code and redundant files. ill try to clean up some stuff but im sure ill miss
lots. `puppet.js` is used by both the web page for showing shared cards as well as
the client app (through a webview), which may partially explain why its kind of convoluted.

## cluster
the cluster is for doing two things- processing a raw audio file into cropped regions,
and turning a set of crops into a sequence (a set of barks into a musical song). its
a docker container deployed on kubernetes. inside the container, there is a express server that
exposes two endpoints public endpoints (for the two tasks). what happens is a client
makes a request to process a raw audio file, say, and the back end receives this request.
it then makes a request to the cluster at the appropriate endpoint. the cluster does
some audio processing, and responds to the back end when complete.
the back end then responds to the client. passing along whatever info is useful.
the audio processing logic is mostly in python,
happening in subprocesses kicked off by the express server.

## deployments
there is a dev server at `https://thedogbarksthesong.ml`
there is a prod server at `https://k-9karaoke.com`
they are both deployed on digital ocean. the servers are ubuntu 18.04
there are a handful of dependencies like ffmpeg, gs utils etc that i will try to document.

each server has a `deploy.sh` in the home dir that attempts to streamline the deployment
process. there are a number of different deployment-like things that ive needed to be able to
do (like sync / migrate stock assets and objects in the db, or update songs), so there
are some flags as well. but basically the script will just grab the latest version of the appropriate
branch from github, pull it down, make sure the python and node dependencies are good, and
restart the server.

the cluster deployment is a google cloud project. there are a number of scripts in the
`/audio_processing/cloud` dir that handle updating and configuring the deployment. they are
in various states of completeness and should probably only be used as reference. the deployment
process for the cluster is basically to build a new docker image, push that to google cloud, then
tell kubernetes to update the cluster with that new image. sometimes easier said than done, but ive
found googles docs helpful.


## more specific guides

- `local_testing.md` is a walk through of getting the back end server running on your local computer, as well
as how to run the docker container that the cluster uses. this is probably the first thing you'll want to
do.
- `models.md` is a discussion of the objects (db tables) that the app uses. they correspond to the logical
abstractions in the code as well, for the most part.
- `deployment.md` is a more detailed outline of deploying builds to the development and production servers.
for the related but distinct topics of song synchronization, and stock object synchronization, see
`songs.md` and `stock_assets.md`.







